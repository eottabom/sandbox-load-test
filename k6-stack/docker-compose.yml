services:
  prometheus:
    image: prom/prometheus:v3.2.1
    container_name: prometheus
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    extra_hosts:
      - "host.docker.internal:host-gateway"
    networks: [k6net]

  influxdb:
    image: influxdb:1.8
    container_name: influxdb
    ports:
      - "8086:8086"
      - "2003:2003"
    environment:
      INFLUXDB_HTTP_AUTH_ENABLED: "false"
      INFLUXDB_DB: "k6"
    volumes:
      - influxdb-data:/var/lib/influxdb
      - ./influxdb/influxdb.conf:/etc/influxdb/influxdb.conf:ro
    networks: [k6net]

  influxdb-init:
    image: curlimages/curl:8.5.0
    container_name: influxdb-init
    depends_on:
      - influxdb
    networks: [k6net]
    volumes:
      - ./influxdb/init:/scripts
    command:
      - /bin/sh
      - -c
      - |
        until curl -sf http://influxdb:8086/ping >/dev/null; do sleep 1; done
        grep -v '^--' /scripts/init.influxql | grep -v '^$$' | while read -r q; do
          curl -sG http://influxdb:8086/query --data-urlencode "q=$$q" >/dev/null
        done

  grafana:
    image: grafana/grafana:10.4.3
    container_name: grafana
    depends_on:
      - influxdb
      - prometheus
    ports:
      - "3000:3000"
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD: admin
      GF_USERS_ALLOW_SIGN_UP: "false"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    networks: [k6net]

  dashboard-downloader:
    image: alpine:3.19
    container_name: dashboard-downloader
    depends_on:
      - grafana
    networks: [k6net]
    volumes:
      - ./grafana/dashboards:/var/lib/grafana/dashboards
    command:
      - /bin/sh
      - -c
      - |
        apk add --no-cache curl jq > /dev/null 2>&1
        mkdir -p /var/lib/grafana/dashboards

        echo "=== Downloading k6 dashboard ==="
        curl -fsSL "https://grafana.com/api/dashboards/14801/revisions/2/download" -o /tmp/k6-raw.json || exit 1
        sed "s/\$${DS_DUMMY}/InfluxDB-k6/g" /tmp/k6-raw.json > /var/lib/grafana/dashboards/k6.json
        echo "k6 dashboard done"

        echo "=== All dashboards downloaded ==="


#  k6:
#    image: grafana/k6:0.49.0
#    container_name: k6
#    depends_on:
#      - influxdb
#    networks: [k6net]
#    volumes:
#      - ./scripts:/scripts
#    environment:
#      # k6 결과를 influxdb(k6 DB)로 전송
#      K6_OUT: influxdb=http://influxdb:8086/k6
#    entrypoint: ["k6"]

networks:
  k6net:

volumes:
  influxdb-data:
  grafana-data:
  prometheus-data:
